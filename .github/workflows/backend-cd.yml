name: Backend CD

on:
  workflow_run:
    workflows: ["Backend CI/CD"]
    types:
      - completed
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_commit }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Build Docker image
      run: |
        docker build -t skillswap-backend:latest .
        docker tag skillswap-backend:latest skillswap-backend:${{ github.sha }}
      if: false  # Uncomment when Docker registry is configured

    - name: Deploy to hosting platform
      working-directory: ./SkillSwap-Backend
      run: |
        echo "Deploying Backend to production..."
        # Configure your deployment platform:
        # - Heroku: heroku deploy
        # - AWS EC2/Elastic Beanstalk: aws deploy push
        # - Azure App Service: az webapp deployment
        # - DigitalOcean App Platform: doctl apps create-deployment
        # - Railway/Render: platform-specific deployment
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}

    - name: Run smoke tests
      working-directory: ./SkillSwap-Backend
      run: |
        echo "Running smoke tests on deployed service..."
        # Add health check curl or test calls here
      env:
        API_URL: ${{ secrets.PRODUCTION_URL }}

    - name: Notify deployment status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}';
          const message = `Backend deployment ${status}`;
          console.log(message);
